@page "/videochat"
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@implements IDisposable

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>
<button @onclick="StartCall">Start Call</button>
<button @onclick="CloseCall">Close Call</button>

@code {
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/videoChatHub"))
            .Build();

        await _hubConnection.StartAsync();
    }

    private async Task StartCall()
    {
        await JSRuntime.InvokeVoidAsync("startCall", DotNetObjectReference.Create(this));
    }

    private async Task CloseCall()
    {
        await JSRuntime.InvokeVoidAsync("closeCall");
    }

    [JSInvokable]
    public async Task OnIceCandidate(string candidate)
    {
        if (!string.IsNullOrEmpty(candidate))
        {
            await _hubConnection?.SendAsync("SendIceCandidate", "targetUsername", candidate);
        }
    }

    public void Dispose()
    {
        _ = _hubConnection?.DisposeAsync();
    }


}
